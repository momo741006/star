<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="è™¹éˆå¾¡æ‰€å æ˜Ÿä¸»è§’ç”Ÿæˆç³»çµ± - åŸºæ–¼çœŸå¯¦å¤©æ–‡è¨ˆç®—çš„D&Dè§’è‰²ç”Ÿæˆå™¨">
    <meta name="keywords" content="å æ˜Ÿ, D&D, è§’è‰²ç”Ÿæˆ, æ˜Ÿç›¤, å æ˜Ÿå­¸, è§’è‰²æ‰®æ¼”">
    <meta name="author" content="è™¹éˆå¾¡æ‰€">

    <!-- PWAç›¸é—œmetaæ¨™ç±¤ -->
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="è™¹éˆå¾¡æ‰€">

    <title>ğŸŒŸ è™¹éˆå¾¡æ‰€å æ˜Ÿä¸»è§’ç”Ÿæˆç³»çµ±</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="./site.webmanifest">

    <!-- åœ–æ¨™é…ç½® -->
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="./icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./icons/favicon-16x16.png">

    <!-- é è¼‰å…¥é—œéµè³‡æº -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Inter:wght@300;400;500;600;700&display=swap" as="style">

    <style>
        /* é—œéµCSSå…§è¯ä»¥æå‡è¼‰å…¥é€Ÿåº¦ */
        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --accent-color: #06b6d4;
            --background-color: #1e1b4b;
            --surface-color: #312e81;
            --text-color: #ffffff;
            --error-color: #ef4444;
            --success-color: #10b981;
            --warning-color: #f59e0b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-color);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem 0;
        }

        .header h1 {
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(30, 27, 75, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--surface-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--error-color);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            max-width: 400px;
        }

        .error-toast.show {
            transform: translateX(0);
        }

        .success-toast {
            background: var(--success-color);
        }

        .warning-toast {
            background: var(--warning-color);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .error-toast {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <!-- è¼‰å…¥ä¸­è¦†è“‹å±¤ -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div id="loading-text">æ­£åœ¨è¼‰å…¥...</div>
    </div>

    <!-- éŒ¯èª¤æç¤ºToast -->
    <div id="error-toast" class="error-toast" style="display: none;">
        <div id="toast-message">ç™¼ç”ŸéŒ¯èª¤</div>
    </div>

    <div class="container">
        <header class="header">
            <h1>ğŸŒŸ è™¹éˆå¾¡æ‰€å æ˜Ÿä¸»è§’ç”Ÿæˆç³»çµ±</h1>
            <p>åŸºæ–¼çœŸå¯¦å¤©æ–‡è¨ˆç®—çš„D&Dè§’è‰²ç”Ÿæˆå™¨</p>
        </header>

        <main>
            <!-- ç³»çµ±ç‹€æ…‹é¡¯ç¤º -->
            <div id="system-status" class="system-status">
                <p>ğŸ”§ è¨ˆç®—å¼•æ“: <span id="engine-status">æª¢æŸ¥ä¸­...</span></p>
                <p>ğŸ“¡ APIç‹€æ…‹: <span id="api-status">é€£æ¥ä¸­...</span></p>
                <p>ğŸ“± PWAç‹€æ…‹: <span id="pwa-status">åˆå§‹åŒ–ä¸­...</span></p>
            </div>

            <!-- åŸæœ‰çš„è¡¨å–®å…§å®¹æœƒåœ¨é€™è£¡... -->
            <div id="main-content">
                <p style="text-align: center; padding: 2rem;">
                    ç³»çµ±æ­£åœ¨åˆå§‹åŒ–ï¼Œè«‹ç¨å€™...
                </p>
            </div>
        </main>
    </div>

    <!-- å¤–éƒ¨å­—é«”è¼‰å…¥ -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Inter:wght@300;400;500;600;700&display=swap">

    <script>
        // ğŸŒŸ è™¹éˆå¾¡æ‰€å‰ç«¯æ ¸å¿ƒ JavaScript

        // å…¨åŸŸé…ç½®
        window.RAINBOW_SPIRIT_CONFIG = {
            API_BASE_URL: location.hostname === 'localhost' || location.hostname === '127.0.0.1' 
                ? 'http://localhost:5000' 
                : 'https://rainbow-spirit-api.railway.app',
            DEBUG: location.hostname === 'localhost',
            VERSION: '1.1.0',
            PWA_ENABLED: true
        };

        // å…¨åŸŸéŒ¯èª¤è™•ç†
        window.addEventListener('error', function(event) {
            console.error('å…¨åŸŸéŒ¯èª¤:', event.error);
            showToast('ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
            if (window.RAINBOW_SPIRIT_CONFIG.DEBUG) {
                console.error('éŒ¯èª¤è©³æƒ…:', event.error);
            }
        });

        // Promiseæ‹’çµ•è™•ç†
        window.addEventListener('unhandledrejection', function(event) {
            console.error('æœªè™•ç†çš„Promiseæ‹’çµ•:', event.reason);
            showToast('ç¶²è·¯è«‹æ±‚å¤±æ•—ï¼Œè«‹æª¢æŸ¥é€£ç·šç‹€æ…‹', 'error');
            event.preventDefault();
        });

        // å·¥å…·å‡½æ•¸
        const Utils = {
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            showLoading(message = 'è¼‰å…¥ä¸­...') {
                const overlay = document.getElementById('loading-overlay');
                const text = document.getElementById('loading-text');
                text.textContent = message;
                overlay.style.display = 'flex';
            },

            hideLoading() {
                const overlay = document.getElementById('loading-overlay');
                overlay.style.display = 'none';
            },

            // APIè«‹æ±‚å°è£
            async apiRequest(endpoint, options = {}) {
                const url = window.RAINBOW_SPIRIT_CONFIG.API_BASE_URL + endpoint;
                const defaultOptions = {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    timeout: 15000
                };

                const mergedOptions = { ...defaultOptions, ...options };

                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), mergedOptions.timeout);

                    const response = await fetch(url, {
                        ...mergedOptions,
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    return await response.json();
                } catch (error) {
                    if (error.name === 'AbortError') {
                        throw new Error('è«‹æ±‚è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
                    }
                    throw error;
                }
            }
        };

        // Toasté€šçŸ¥ç³»çµ±
        function showToast(message, type = 'error') {
            const toast = document.getElementById('error-toast');
            const messageElement = document.getElementById('toast-message');

            // ç§»é™¤èˆŠçš„é¡åˆ¥
            toast.classList.remove('error-toast', 'success-toast', 'warning-toast');

            // æ·»åŠ æ–°çš„é¡åˆ¥
            if (type === 'success') {
                toast.classList.add('success-toast');
            } else if (type === 'warning') {
                toast.classList.add('warning-toast');
            } else {
                toast.classList.add('error-toast');
            }

            messageElement.textContent = message;
            toast.style.display = 'block';

            // é¡¯ç¤ºå‹•ç•«
            setTimeout(() => toast.classList.add('show'), 100);

            // è‡ªå‹•éš±è—
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.style.display = 'none', 300);
            }, 5000);
        }

        // Service Worker è¨»å†Š
        async function registerServiceWorker() {
            if (!('serviceWorker' in navigator)) {
                console.log('æ­¤ç€è¦½å™¨ä¸æ”¯æ´Service Worker');
                updatePWAStatus('ä¸æ”¯æ´');
                return false;
            }

            try {
                console.log('ğŸ”§ è¨»å†ŠService Worker...');
                const registration = await navigator.serviceWorker.register('./service_worker.js', {
                    scope: './'
                });

                console.log('âœ… Service Workerè¨»å†ŠæˆåŠŸ:', registration);

                // ç›£è½SWç‹€æ…‹è®ŠåŒ–
                registration.addEventListener('updatefound', () => {
                    console.log('ğŸ”„ ç™¼ç¾Service Workeræ›´æ–°');
                    const newWorker = registration.installing;

                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            showToast('æ‡‰ç”¨ç¨‹å¼å·²æ›´æ–°ï¼Œé‡æ–°æ•´ç†ä»¥ç²å¾—æœ€æ–°ç‰ˆæœ¬', 'success');
                        }
                    });
                });

                updatePWAStatus('å·²å•Ÿç”¨');
                return true;

            } catch (error) {
                console.error('âŒ Service Workerè¨»å†Šå¤±æ•—:', error);
                updatePWAStatus('è¨»å†Šå¤±æ•—');
                return false;
            }
        }

        // ç³»çµ±ç‹€æ…‹æ›´æ–°
        function updateEngineStatus(status) {
            const element = document.getElementById('engine-status');
            element.textContent = status;
        }

        function updateAPIStatus(status) {
            const element = document.getElementById('api-status');
            element.textContent = status;
        }

        function updatePWAStatus(status) {
            const element = document.getElementById('pwa-status');
            element.textContent = status;
        }

        // ç³»çµ±åˆå§‹åŒ–
        async function initializeSystem() {
            try {
                Utils.showLoading('æ­£åœ¨åˆå§‹åŒ–ç³»çµ±...');

                // 1. è¨»å†ŠService Worker
                const swRegistered = await registerServiceWorker();

                // 2. æª¢æŸ¥APIç‹€æ…‹
                Utils.showLoading('æª¢æŸ¥APIç‹€æ…‹...');
                try {
                    const healthCheck = await Utils.apiRequest('/api/health');
                    updateAPIStatus('âœ… æ­£å¸¸');
                    updateEngineStatus(healthCheck.engine || 'æœªçŸ¥');
                } catch (error) {
                    console.error('APIå¥åº·æª¢æŸ¥å¤±æ•—:', error);
                    updateAPIStatus('âŒ é€£ç·šå¤±æ•—');
                    updateEngineStatus('ç„¡æ³•é€£æ¥');
                    showToast('APIæœå‹™ç„¡æ³•é€£æ¥ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™', 'warning');
                }

                // 3. è¼‰å…¥ä¸»è¦å…§å®¹
                Utils.showLoading('è¼‰å…¥ä¸»è¦å…§å®¹...');
                await loadMainContent();

                Utils.hideLoading();
                showToast('ç³»çµ±åˆå§‹åŒ–å®Œæˆ', 'success');

            } catch (error) {
                console.error('ç³»çµ±åˆå§‹åŒ–å¤±æ•—:', error);
                Utils.hideLoading();
                showToast('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
            }
        }

        // è¼‰å…¥ä¸»è¦å…§å®¹
        async function loadMainContent() {
            const mainContent = document.getElementById('main-content');

            // é€™è£¡æœƒè¼‰å…¥åŸæœ¬çš„è¡¨å–®å…§å®¹
            mainContent.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <h2>ğŸ² è§’è‰²ç”Ÿæˆå™¨</h2>
                    <p>è«‹è¼¸å…¥æ‚¨çš„å‡ºç”Ÿè³‡è¨Šä»¥ç”Ÿæˆå°ˆå±¬çš„D&Dè§’è‰²</p>
                    <br>
                    <form id="character-form">
                        <div class="form-group">
                            <label for="name">å§“åï¼š</label>
                            <input type="text" id="name" name="name" required>
                        </div>
                        <!-- å…¶ä»–è¡¨å–®æ¬„ä½æœƒåœ¨é€™è£¡æ·»åŠ ... -->
                        <button type="submit">ç”Ÿæˆè§’è‰²</button>
                    </form>
                </div>
            `;

            // ç¶å®šè¡¨å–®äº‹ä»¶
            const form = document.getElementById('character-form');
            form.addEventListener('submit', handleFormSubmit);
        }

        // è¡¨å–®æäº¤è™•ç†
        async function handleFormSubmit(event) {
            event.preventDefault();

            try {
                Utils.showLoading('æ­£åœ¨ç”Ÿæˆæ‚¨çš„å°ˆå±¬è§’è‰²...');

                const formData = new FormData(event.target);
                const data = Object.fromEntries(formData);

                const result = await Utils.apiRequest('/api/calculate_chart', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                Utils.hideLoading();
                showToast('è§’è‰²ç”ŸæˆæˆåŠŸï¼', 'success');
                displayCharacterResult(result);

            } catch (error) {
                console.error('è§’è‰²ç”Ÿæˆå¤±æ•—:', error);
                Utils.hideLoading();
                showToast('è§’è‰²ç”Ÿæˆå¤±æ•—ï¼š' + error.message, 'error');
            }
        }

        // é¡¯ç¤ºè§’è‰²çµæœ
        function displayCharacterResult(result) {
            // å¯¦ä½œè§’è‰²çµæœé¡¯ç¤ºé‚è¼¯
            console.log('è§’è‰²ç”Ÿæˆçµæœ:', result);
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initializeSystem);

        // PWAå®‰è£æç¤º
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // é¡¯ç¤ºå®‰è£æŒ‰éˆ•æˆ–æç¤º
            setTimeout(() => {
                showToast('å¯ä»¥å°‡æ­¤æ‡‰ç”¨å®‰è£åˆ°æ‚¨çš„è£ç½®ä¸Šï¼', 'success');
            }, 5000);
        });

        // å®‰è£PWA
        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log('PWAå®‰è£çµæœ:', outcome);
                deferredPrompt = null;
            }
        }

        console.log('ğŸŒŸ è™¹éˆå¾¡æ‰€å æ˜Ÿç³»çµ±å·²è¼‰å…¥ v' + window.RAINBOW_SPIRIT_CONFIG.VERSION);

    </script>
</body>
</html>