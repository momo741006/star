<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="虹靈御所占星主角生成系統 - 基於真實天文計算的D&D角色生成器">
    <meta name="keywords" content="占星, D&D, 角色生成, 星盤, 占星學, 角色扮演">
    <meta name="author" content="虹靈御所">

    <!-- PWA相關meta標籤 -->
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="虹靈御所">

    <title>🌟 虹靈御所占星主角生成系統</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="./site.webmanifest">

    <!-- 圖標配置 -->
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="./icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./icons/favicon-16x16.png">

    <!-- 預載入關鍵資源 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Inter:wght@300;400;500;600;700&display=swap" as="style">

    <style>
        /* 關鍵CSS內聯以提升載入速度 */
        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --accent-color: #06b6d4;
            --background-color: #1e1b4b;
            --surface-color: #312e81;
            --text-color: #ffffff;
            --error-color: #ef4444;
            --success-color: #10b981;
            --warning-color: #f59e0b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-color);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem 0;
        }

        .header h1 {
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(30, 27, 75, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--surface-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--error-color);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            max-width: 400px;
        }

        .error-toast.show {
            transform: translateX(0);
        }

        .success-toast {
            background: var(--success-color);
        }

        .warning-toast {
            background: var(--warning-color);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .error-toast {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <!-- 載入中覆蓋層 -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div id="loading-text">正在載入...</div>
    </div>

    <!-- 錯誤提示Toast -->
    <div id="error-toast" class="error-toast" style="display: none;">
        <div id="toast-message">發生錯誤</div>
    </div>

    <div class="container">
        <header class="header">
            <h1>🌟 虹靈御所占星主角生成系統</h1>
            <p>基於真實天文計算的D&D角色生成器</p>
        </header>

        <main>
            <!-- 系統狀態顯示 -->
            <div id="system-status" class="system-status">
                <p>🔧 計算引擎: <span id="engine-status">檢查中...</span></p>
                <p>📡 API狀態: <span id="api-status">連接中...</span></p>
                <p>📱 PWA狀態: <span id="pwa-status">初始化中...</span></p>
            </div>

            <!-- 原有的表單內容會在這裡... -->
            <div id="main-content">
                <p style="text-align: center; padding: 2rem;">
                    系統正在初始化，請稍候...
                </p>
            </div>
        </main>
    </div>

    <!-- 外部字體載入 -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Inter:wght@300;400;500;600;700&display=swap">

    <script>
        // 🌟 虹靈御所前端核心 JavaScript

        // 全域配置
        window.RAINBOW_SPIRIT_CONFIG = {
            API_BASE_URL: location.hostname === 'localhost' || location.hostname === '127.0.0.1' 
                ? 'http://localhost:5000' 
                : (window.location.origin.includes('github.io') 
                    ? 'https://star-production-9df4.up.railway.app'
                    : window.location.origin),
            DEBUG: location.hostname === 'localhost',
            VERSION: '1.2.0',
            PWA_ENABLED: true
        };

        // 全域錯誤處理
        window.addEventListener('error', function(event) {
            console.error('全域錯誤:', event.error);
            showToast('系統發生錯誤，請重新整理頁面', 'error');
            if (window.RAINBOW_SPIRIT_CONFIG.DEBUG) {
                console.error('錯誤詳情:', event.error);
            }
        });

        // Promise拒絕處理
        window.addEventListener('unhandledrejection', function(event) {
            console.error('未處理的Promise拒絕:', event.reason);
            showToast('網路請求失敗，請檢查連線狀態', 'error');
            event.preventDefault();
        });

        // 工具函數
        const Utils = {
            // 顯示載入狀態
            showLoading(message = '載入中...') {
                const overlay = document.getElementById('loading-overlay');
                const text = document.getElementById('loading-text');
                text.textContent = message;
                overlay.style.display = 'flex';
            },

            hideLoading() {
                const overlay = document.getElementById('loading-overlay');
                overlay.style.display = 'none';
            },

            // API請求封裝
            async apiRequest(endpoint, options = {}) {
                const url = window.RAINBOW_SPIRIT_CONFIG.API_BASE_URL + endpoint;
                const defaultOptions = {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    timeout: 15000
                };

                const mergedOptions = { ...defaultOptions, ...options };

                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), mergedOptions.timeout);

                    const response = await fetch(url, {
                        ...mergedOptions,
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    return await response.json();
                } catch (error) {
                    if (error.name === 'AbortError') {
                        throw new Error('請求超時，請檢查網路連線');
                    }
                    throw error;
                }
            }
        };

        // Toast通知系統
        function showToast(message, type = 'error') {
            const toast = document.getElementById('error-toast');
            const messageElement = document.getElementById('toast-message');

            // 移除舊的類別
            toast.classList.remove('error-toast', 'success-toast', 'warning-toast');

            // 添加新的類別
            if (type === 'success') {
                toast.classList.add('success-toast');
            } else if (type === 'warning') {
                toast.classList.add('warning-toast');
            } else {
                toast.classList.add('error-toast');
            }

            messageElement.textContent = message;
            toast.style.display = 'block';

            // 顯示動畫
            setTimeout(() => toast.classList.add('show'), 100);

            // 自動隱藏
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.style.display = 'none', 300);
            }, 5000);
        }

        // Service Worker 註冊
        async function registerServiceWorker() {
            if (!('serviceWorker' in navigator)) {
                console.log('此瀏覽器不支援Service Worker');
                updatePWAStatus('不支援');
                return false;
            }

            try {
                console.log('🔧 註冊Service Worker...');
                const registration = await navigator.serviceWorker.register('./service_worker.js', {
                    scope: './'
                });

                console.log('✅ Service Worker註冊成功:', registration);

                // 監聽SW狀態變化
                registration.addEventListener('updatefound', () => {
                    console.log('🔄 發現Service Worker更新');
                    const newWorker = registration.installing;

                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            showToast('應用程式已更新，重新整理以獲得最新版本', 'success');
                        }
                    });
                });

                updatePWAStatus('已啟用');
                return true;

            } catch (error) {
                console.error('❌ Service Worker註冊失敗:', error);
                updatePWAStatus('註冊失敗');
                return false;
            }
        }

        // 系統狀態更新
        function updateEngineStatus(status) {
            const element = document.getElementById('engine-status');
            element.textContent = status;
        }

        function updateAPIStatus(status) {
            const element = document.getElementById('api-status');
            element.textContent = status;
        }

        function updatePWAStatus(status) {
            const element = document.getElementById('pwa-status');
            element.textContent = status;
        }

        // 系統初始化
        async function initializeSystem() {
            try {
                Utils.showLoading('正在初始化系統...');

                // 1. 註冊Service Worker
                const swRegistered = await registerServiceWorker();

                // 2. 檢查API狀態
                Utils.showLoading('檢查API狀態...');
                try {
                    const healthCheck = await Utils.apiRequest('/api/health');
                    updateAPIStatus('✅ 正常');
                    updateEngineStatus(healthCheck.engine || '未知');
                } catch (error) {
                    console.error('API健康檢查失敗:', error);
                    updateAPIStatus('❌ 連線失敗');
                    updateEngineStatus('無法連接');
                    showToast('API服務無法連接，部分功能可能受限', 'warning');
                }

                // 3. 載入主要內容
                Utils.showLoading('載入主要內容...');
                await loadMainContent();

                Utils.hideLoading();
                showToast('系統初始化完成', 'success');

            } catch (error) {
                console.error('系統初始化失敗:', error);
                Utils.hideLoading();
                showToast('系統初始化失敗，請重新整理頁面', 'error');
            }
        }

        // 載入主要內容
        async function loadMainContent() {
            const mainContent = document.getElementById('main-content');

            // 載入完整的表單內容
            mainContent.innerHTML = `
                <div style="max-width: 600px; margin: 0 auto; padding: 2rem; background: rgba(255,255,255,0.1); border-radius: 15px;">
                    <h2 style="text-align: center; margin-bottom: 2rem;">🎲 占星D&D角色生成器</h2>
                    <p style="text-align: center; margin-bottom: 2rem; opacity: 0.9;">請輸入您的出生資訊以生成專屬的D&D角色</p>
                    
                    <form id="character-form" style="display: flex; flex-direction: column; gap: 1.5rem;">
                        <div class="form-group">
                            <label for="name" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">姓名 *</label>
                            <input type="text" id="name" name="name" required 
                                   style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 1rem;"
                                   placeholder="請輸入您的姓名">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="year" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">年份 *</label>
                                <input type="number" id="year" name="year" required min="1900" max="2050" value="1990"
                                       style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                            </div>
                            <div class="form-group">
                                <label for="month" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">月份 *</label>
                                <input type="number" id="month" name="month" required min="1" max="12" value="6"
                                       style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                            </div>
                            <div class="form-group">
                                <label for="day" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">日期 *</label>
                                <input type="number" id="day" name="day" required min="1" max="31" value="15"
                                       style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="hour" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">時 *</label>
                                <input type="number" id="hour" name="hour" required min="0" max="23" value="14"
                                       style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                            </div>
                            <div class="form-group">
                                <label for="minute" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">分 *</label>
                                <input type="number" id="minute" name="minute" required min="0" max="59" value="30"
                                       style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="city" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">出生城市 *</label>
                            <input type="text" id="city" name="city" required value="台北"
                                   style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 1rem;">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="longitude" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">經度 *</label>
                                <input type="number" id="longitude" name="longitude" required step="0.01" value="121.55"
                                       style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                            </div>
                            <div class="form-group">
                                <label for="latitude" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">緯度 *</label>
                                <input type="number" id="latitude" name="latitude" required step="0.01" value="25.017"
                                       style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="timezone" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">時區</label>
                            <select id="timezone" name="timezone"
                                    style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.2); color: white; font-size: 1rem;">
                                <option value="Asia/Taipei">Asia/Taipei (台北)</option>
                                <option value="Asia/Tokyo">Asia/Tokyo (東京)</option>
                                <option value="Asia/Shanghai">Asia/Shanghai (上海)</option>
                                <option value="Asia/Hong_Kong">Asia/Hong_Kong (香港)</option>
                                <option value="America/New_York">America/New_York (紐約)</option>
                                <option value="America/Los_Angeles">America/Los_Angeles (洛杉磯)</option>
                                <option value="Europe/London">Europe/London (倫敦)</option>
                                <option value="Europe/Paris">Europe/Paris (巴黎)</option>
                            </select>
                        </div>
                        
                        <button type="submit" 
                                style="width: 100%; padding: 1rem; font-size: 1.1rem; font-weight: 600; border-radius: 8px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.3);"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.4)';"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.3)';">
                            🌟 生成我的專屬角色
                        </button>
                    </form>
                    
                    <div id="result-container" style="margin-top: 2rem; display: none;"></div>
                </div>
            `;

            // 綁定表單事件
            const form = document.getElementById('character-form');
            form.addEventListener('submit', handleFormSubmit);
        }

        // 表單提交處理
        async function handleFormSubmit(event) {
            event.preventDefault();

            try {
                Utils.showLoading('正在生成您的專屬角色...');

                const formData = new FormData(event.target);
                const data = Object.fromEntries(formData);

                const result = await Utils.apiRequest('/api/calculate_chart', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                Utils.hideLoading();
                showToast('角色生成成功！', 'success');
                displayCharacterResult(result);

            } catch (error) {
                console.error('角色生成失敗:', error);
                Utils.hideLoading();
                showToast('角色生成失敗：' + error.message, 'error');
            }
        }

        // 顯示角色結果
        function displayCharacterResult(result) {
            const resultContainer = document.getElementById('result-container');
            
            if (!result || !result.character) {
                resultContainer.innerHTML = '<p style="color: #ef4444;">無法顯示角色資訊</p>';
                resultContainer.style.display = 'block';
                return;
            }
            
            const char = result.character;
            const birthChart = char.birth_chart || {};
            
            resultContainer.innerHTML = `
                <div style="background: rgba(255,255,255,0.1); border-radius: 15px; padding: 2rem; border: 2px solid rgba(255,255,255,0.2);">
                    <h2 style="text-align: center; margin-bottom: 2rem; font-size: 2rem;">✨ 您的專屬角色 ✨</h2>
                    
                    <!-- 角色基本資訊 -->
                    <div style="background: rgba(102,126,234,0.3); border-radius: 10px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h3 style="margin-bottom: 1rem; color: #ffd700;">🎭 角色資訊</h3>
                        <p style="font-size: 1.3rem; margin-bottom: 0.5rem;"><strong>姓名：</strong>${char.name}</p>
                        <p style="font-size: 1.2rem; margin-bottom: 0.5rem;"><strong>職業：</strong>${char.class?.name || '未知'}</p>
                        <p style="margin-bottom: 0.5rem;"><strong>職業描述：</strong>${char.class?.description || ''}</p>
                        <p style="font-size: 1.5rem; margin-top: 1rem;"><strong>評級：</strong><span style="color: #ffd700; font-size: 2rem; font-weight: bold;">${char.rating}</span></p>
                    </div>
                    
                    <!-- 屬性值 -->
                    <div style="background: rgba(139,92,246,0.3); border-radius: 10px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h3 style="margin-bottom: 1rem; color: #ffd700;">📊 角色屬性</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">💪 力量 (STR)</div>
                                <div style="font-size: 1.5rem; color: #10b981;">${char.stats?.strength || 10}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">🏃 敏捷 (DEX)</div>
                                <div style="font-size: 1.5rem; color: #10b981;">${char.stats?.dexterity || 10}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">❤️ 體質 (CON)</div>
                                <div style="font-size: 1.5rem; color: #10b981;">${char.stats?.constitution || 10}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">🧠 智力 (INT)</div>
                                <div style="font-size: 1.5rem; color: #10b981;">${char.stats?.intelligence || 10}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">🔮 智慧 (WIS)</div>
                                <div style="font-size: 1.5rem; color: #10b981;">${char.stats?.wisdom || 10}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">✨ 魅力 (CHA)</div>
                                <div style="font-size: 1.5rem; color: #10b981;">${char.stats?.charisma || 10}</div>
                            </div>
                        </div>
                        <p style="text-align: center; margin-top: 1rem; font-size: 1.2rem;">
                            <strong>總屬性值：</strong><span style="color: #ffd700; font-size: 1.5rem;">${char.total_stats || 0}</span>
                        </p>
                    </div>
                    
                    <!-- 星盤資訊 -->
                    <div style="background: rgba(6,182,212,0.3); border-radius: 10px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h3 style="margin-bottom: 1rem; color: #ffd700;">🌟 星盤資訊</h3>
                        <div style="display: grid; gap: 0.5rem;">
                            <p><strong>☀️ 太陽：</strong>${birthChart.sun || '計算中'}</p>
                            <p><strong>🌙 月亮：</strong>${birthChart.moon || '計算中'}</p>
                            <p><strong>⬆️ 上升：</strong>${birthChart.ascendant || '計算中'}</p>
                        </div>
                    </div>
                    
                    <!-- 角色背景 -->
                    <div style="background: rgba(245,158,11,0.3); border-radius: 10px; padding: 1.5rem;">
                        <h3 style="margin-bottom: 1rem; color: #ffd700;">📖 角色背景故事</h3>
                        <p style="line-height: 1.8; text-align: justify;">${char.background || '一位神秘的冒險者，準備開啟新的旅程...'}</p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <button onclick="window.print()" 
                                style="padding: 0.75rem 2rem; font-size: 1rem; font-weight: 600; border-radius: 8px; border: none; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; cursor: pointer; margin-right: 1rem;">
                            🖨️ 列印角色卡
                        </button>
                        <button onclick="location.reload()" 
                                style="padding: 0.75rem 2rem; font-size: 1rem; font-weight: 600; border-radius: 8px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; cursor: pointer;">
                            🔄 重新生成
                        </button>
                    </div>
                </div>
            `;
            
            resultContainer.style.display = 'block';
            resultContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', initializeSystem);

        // PWA安裝提示
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // 顯示安裝按鈕或提示
            setTimeout(() => {
                showToast('可以將此應用安裝到您的裝置上！', 'success');
            }, 5000);
        });

        // 安裝PWA
        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log('PWA安裝結果:', outcome);
                deferredPrompt = null;
            }
        }

        console.log('🌟 虹靈御所占星系統已載入 v' + window.RAINBOW_SPIRIT_CONFIG.VERSION);

    </script>
</body>
</html>
